# Task Analysis Log

Этот файл используется для фиксации результатов этапов из `AGENTS.md`.

## TASK ANALYSIS
_(заполняется перед началом реализации; фиксируем, что именно нужно сделать)_

### 2023-12-16 — Адаптация AGENTS.md под GDScript
- Пользователь поделился примером `AGENTS.md` из Rust-проекта и попросил проанализировать его.
- Цель: перенести релевантные правила в собственный `AGENTS.md`, прежде чем вносить правки.

### 2023-12-16 — Уточнения от пользователя
- Все рабочие заметки/этапы логируем в `docs/notes`.
- Единственный язык задач — GDScript.
- MCP/документация: использовать https://context7.com/godotengine/godot.
- Документацию обязательно обновлять, следовать стилю из context7, использовать табы вместо пробелов.

### 2023-12-16 — Конспект `gdscript_guidelines.md`
- После добавления секции `# GDScript guidelines` в `AGENTS.md` нужно кратко изложить правила из `docs/gdscript_guidelines.md` (на английском) и вставить их в соответствующий блок.

### 2023-12-16 — Фиксация версии Godot
- Пользователь хочет описать в `AGENTS.md`, какую версию Godot Engine необходимо использовать (сейчас 4.5), и понять, где это видно в проекте.

### 2025-12-16 — Создание Tech Design Document
- Пользователь предоставил полный текст технического дизайна игры и попросил оформить его как markdown-файл в каталоге `docs`.
- Нужно перенести структуру (11 разделов + подразделы) без искажений, обеспечить читабельное форматирование и при необходимости добавить перекрёстные ссылки на существующие документы.
- Важно сохранить русскоязычную терминологию разделов и убедиться, что документ описывает текущее техническое видение (web + mobile).

### 2025-12-16 — Документация шага «Project skeleton»
- Пользователь прислал подробное руководство по первому шагу реализации (Project skeleton) и хочет вынести его в отдельный файл в `docs/`.
- Нужно оформить материал как самостоятельную статью (один файл на шаг), снабдить перекрёстными ссылками на основной TDD и поддерживать с TDD согласованные формулировки.
- Также необходимо обновить TDD, чтобы раздел 11 (итерации) ссылался на конкретный файл шага, и при необходимости дополнить `docs/project.md`.

### 2025-12-16 — Ошибка типизации в RunManager
- Пользователь сообщил об ошибке загрузки: GDScript не может вывести тип переменной `debt` в `_process_emergency_cost()` (`scripts/autoload/run_manager.gd:199`).
- Нужно привести значение `shift_payout_debt` к `int` до присваивания и убедиться, что логика обновления HUD остаётся прежней.

### 2025-12-16 — Сломан экран ShiftSummary
- В сборке (Wardrobe.command) экран итогов показывает пустоту вместо текста “Summary placeholder” и не реагирует на кнопку `Back to Menu`.
- Нужно проверить `scripts/ui/shift_summary.gd`: убедиться, что `apply_payload()` не вызывается до `_ready()`, что `_summary_label` обновляется, и что кнопка ищет `RunManager` даже если он не был найден в `_ready()`.

### 2025-12-16 — Parse error из-за `? :`
- В `scripts/ui/shift_summary.gd` строка `report.get("triggered", false) ? "Yes" : "No"` вызывает `Unexpected "?" in source` (Godot не поддерживает C-подобный тернарный оператор).
- Нужно переписать выражение в стиле GDScript (`"Yes" if condition else "No"`) и обновить оба документа с гайдами (`docs/gdscript_guidelines.md` и секция `GDScript guidelines` в `AGENTS.md`), чтобы зафиксировать правило.

### 2025-12-16 — Тип triggered_flag нарушает гайд
- После предыдущей правки ShiftSummary переменная `triggered_flag` объявлена как `var triggered_flag := report.get(...)`, что нарушает правило о приведении Variant.
- Нужно привести значение к `bool` (через `bool(...)` или типизированное объявление) и обновить журнал этапов.

### 2025-12-16 — Сквош последних коммитов
- Пользователь попросил объединить два последних коммита в один.
- Нужно сохранить все изменения и написать короткое английское сообщение, описывающее итог этих коммитов.

### 2025-12-22 — Разделение interaction_engine на domain/legacy (Task Analysis)
- Текущий `scripts/app/interaction/interaction_engine.gd` содержит доменную логику (storage state) и legacy-ветку, работающую с Node-адаптером.
- Нужно отделить legacy-ветку в адаптерный слой и сохранить контракт событий/результатов для UI и систем.
- Зависимости затрагивают `scripts/ui/wardrobe_scene.gd`, `scripts/ui/wardrobe_interaction_events.gd`, `scripts/wardrobe/interaction_event_adapter.gd`, `scripts/app/desk/desk_service_point_system.gd`, а также unit-тесты взаимодействий.
- Требуется определить новое место для констант событий (и кто ими владеет), чтобы не смешивать domain и UI.

## PLANNING: CODING
_(пошаговый план действий, который делаем после анализа)_

### 2023-12-16 — План по запросу
1. Обновить `AGENTS.md`, добавив полученные требования (docs/notes как рабочий путь, язык GDScript, ссылка на context7, обязательность обновлений документации, стиль/tab-инденты).
2. Зафиксировать изменения в этом файле (текущая заметка) и при необходимости скорректировать другие документы.

### 2023-12-16 — План по переводу AGENTS.md
1. Перевести все русскоязычные формулировки в `AGENTS.md` на английский, сохранив структуру и смысл.
2. Проверить, что текст остаётся последовательным и соответствует требованиям.

### 2023-12-16 — План по конспекту GDScript правил
1. Прочитать `docs/gdscript_guidelines.md` и выделить основные пункты.
2. Сформулировать лаконичный список правил на английском и добавить его в секцию `# GDScript guidelines` файла `AGENTS.md`.
3. После внесения изменений обновить этот журнал и убедиться, что документация актуальна.

### 2023-12-16 — План по коммитам
1. Проверить `git status` и убедиться, что в рабочем дереве нет чужих файлов в stage.
2. Проиндексировать файлы, относящиеся к настройкам `AGENTS.md` (сам файл, `docs/gdscript_guidelines.md`, записи в `docs/notes/...`).
3. Создать коммит с описанием изменений.
4. Снять индексацию (если нужно) и затем отдельно проиндексировать изменения в `export_presets.cfg`, создать второй коммит.

### 2023-12-16 — План по фиксации версии Godot
1. Найти, где в проекте фигурирует версия 4.5 (например, строка `config/features` в `project.godot`).
2. Заполнить секцию `## Godot Enguine Version` в `AGENTS.md`, указав требуемую версию и инструкцию по обновлению.
3. Сделать запись об изменении здесь и объяснить пользователю, где смотреть версию.

### 2023-12-16 — План по сквошу
1. Выполнить `git reset --soft HEAD~2`, чтобы вернуть изменения двух последних коммитов в индекс/рабочее дерево.
2. Создать новый коммит с объединённым описанием (охватывает AGENTS и export presets).
3. Проверить `git status`, убедиться, что лишние файлы не попали, и записать результат в журнал.

### 2023-12-16 — План: ответ по headless-билдам
1. Сформулировать краткое описание CLI-процесса сборки Godot (использование `godot`/`godot4` с `--headless` и `--export[-release]`).
2. Указать, что такие команды требуют настроенных export presets и приложить пример для трёх конфигураций.

### 2023-12-16 — План: команды для конкретных пресетов
1. Проверить названия пресетов в `export_presets.cfg` (`Web (itch.io)`, `Web (local)`, `macOS`).
2. Сформировать команды вида `godot4 --headless --export[-release/-debug] "<preset>" <output_path>` (release для itch.io, debug для остальных).
3. Добавить краткое пояснение (куда кладём результат, какие шаблоны нужны).

### 2023-12-16 — План: создать конфигурацию `just`
1. Создать `justfile` в корне проекта.
2. Добавить задачи `web-itch`, `web-local`, `mac-debug` с соответствующими командами `godot4 --headless --export-*`.
3. Добавить задачу `build-all`, зависящую от трёх предыдущих.

### 2025-12-16 — План по подготовке TDD
1. Проверить текущую структуру каталога `docs/` и выбрать консистентное имя файла (например, `docs/technical_design_document.md`).
2. Создать файл и перенести предоставленный текст, аккуратно сверстать заголовки/списки/примечания в markdown, убедившись, что нумерация разделов сохранена.
3. Добавить при необходимости краткое описание/ссылку на новый документ в `docs/project.md`, чтобы читатели нашли TDD.
4. Залить изменения (новый файл + обновления заметок) в репозиторий после прохождения этапов coding/verification.

### 2025-12-16 — План по документации шага
1. Создать подкаталог `docs/steps/` (если ещё нет) и файл `01_project_skeleton.md`, куда перенести предоставленный текст, адаптировав под markdown (заголовки, списки, выделения).
2. Добавить в TDD (раздел 11, пункт 1) ссылку на новый файл, чтобы читатели могли перейти к detalied instructions; при необходимости обновить и другие документы (например, `docs/project.md`), если там полезно упомянуть шаги.
3. Зафиксировать изменения в этом журнале (coding/verification), убедиться в корректных перекрёстных ссылках (шаг ↔︎ TDD) и провести финальную проверку форматирования.

### 2025-12-16 — План: аудит неопределённых сценариев
1. Повторно перечитать `docs/technical_design_document.md` и `docs/steps/01_project_skeleton.md`, зафиксировать места, где оставлено неопределённое поведение (заглушки, «или почти», выбор между вариантами без финального решения).
2. Проверить текущую реализацию (autoload-скрипты, сцены UI, файлы `content`) и определить, покрыт ли каждый спорный сценарий кодом.
3. Для реализованных сценариев детализировать документацию (обновить разделы с описанием RunManager, HUD, SaveManager и т.п., соблюдая таб-инденты).
4. Для нереализованных сценариев составить список неопределённостей, который попадёт в финальный ответ.

### 2025-12-16 — План: обновление Magic/Inspection
1. Уточнить TDD: описать конфигурируемые режимы MagicSystem (`insurance_mode`, `emergency_cost_mode`, эффекты подсветки, TBD по числам) и расписание Inspection/Cleanliness (режимы A/B, эмуляция в MVP, хранение счётчиков в RunState, логирование причин).
2. Добавить кодовые заглушки: создать `scripts/sim/magic_system.gd` и `scripts/sim/inspection_system.gd` с конфигами и базовыми методами (`apply_insurance`, `request_emergency_locate`, `record_entropy`, `build_summary_entry`), а также расширить `RunManager` (state со счётчиками, связывание систем, настройка дефолтных режимов).
3. Обновить соответствующую документацию (Step 1 при необходимости) и журнал проверок, убедиться, что новые конфиги легко менять через словари/Resources без переписывания логики.

### 2025-12-16 — План: унификация сохранений
1. Обновить TDD (раздел 9) и Step 1 так, чтобы они однозначно ссылались на схему из двух файлов `user://save_meta.json` (meta) и `user://save_run.json` (опциональный mid-run).
2. Расширить `SaveManager.gd`: добавить константу `RUN_SAVE_PATH`, заглушки `load_run_state()`, `save_run_state()`, `clear_run_save()`, чтобы код отражал выбранную архитектуру.
3. Зафиксировать изменения в журнале (coding/verification) после проверки.

### 2025-12-16 — План: Variant inference warning
1. Исправить `scripts/sim/inspection_system.gd`, добавив явные преобразования к `float` при чтении значений из словаря `run_state`.
2. Обновить `docs/gdscript_guidelines.md`, добавив рекомендацию приводить `Variant` к ожидаемому типу после `Dictionary.get()`/`JSON.parse_string()` и подобных вызовов.
3. Зафиксировать изменения в журнале и убедиться, что предупреждения не появляются.

### 2025-12-16 — План: Ghost light rule
1. Обновить `docs/technical_design_document.md`: уточнить описание Ghost в SpecialRulesSystem, дописать раздел про UX и технические требования (presentation-first), добавить упоминание проверки в PlacementSystem.
2. В секции данных (ItemRuleRes/ClientArchetypeRes) добавить параметры `ghost_interaction_blocked_when_lit`, `ghost_visibility_alpha_when_lit`, `light_rule`.
3. Задокументировать обновление (журнал + при необходимости Step 1/другие документы).

### 2025-12-16 — План: исправить типизацию RunManager
1. В `_process_emergency_cost()` привести `_run_state.get("shift_payout_debt", 0)` к `int` перед вычислением, чтобы переменная `debt` имела явный тип.
2. Проверить остальные ветки метода и соседние функции на аналогичные обращения к Variant, при необходимости добавить явные касты и убедиться, что HUD обновляется корректно.

### 2025-12-16 — План: восстановить ShiftSummary
1. Проанализировать `scripts/ui/shift_summary.gd`: добавить флаг готовности, чтобы `apply_payload()` не пытался обновить UI до того, как `@onready`-узлы проинициализированы.
2. Обновить обработчик кнопки: при нажатии ещё раз искать `RunManager` через `get_node_or_null`, логировать предупреждение, если автозагрузка всё ещё недоступна, и при наличии запрашивать переход в меню.
3. После правок проверить, что `_refresh()` защищён от отсутствия `_summary_label` и всегда показывает хотя бы placeholder.

### 2025-12-16 — План: сквош последних коммитов
1. Проверить историю и диапазон (`git log -2`) чтобы подтвердить, какие два коммита нужно объединить.
2. Выполнить `git reset --soft HEAD~2`, чтобы вернуть изменения в индекс одним набором.
3. Создать новый коммит с лаконичным английским сообщением, отражающим смысл обеих правок.
4. Убедиться через `git log -2 --oneline`, что остался один свежий коммит с нужным описанием.

### 2025-12-16 — План: запретить `? :` в коде
1. В `scripts/ui/shift_summary.gd` заменить использование `? :` на выражение `value_if_true if condition else value_if_false`.
2. Дополнить правила в `docs/gdscript_guidelines.md` и блок `## GDScript guidelines` (`AGENTS.md`), описав, что Godot поддерживает только Python-подобный тернарный оператор и нельзя копировать `?:` из других языков.

### 2025-12-16 — План: тип triggered_flag
1. В `_refresh()` привести результат `report.get("triggered", false)` к `bool` и задать тип переменной, чтобы IDE не определял `Variant`.
2. Просмотреть остальные новые переменные в файле, чтобы убедиться, что нет других аналогичных нарушений.

### 2025-12-16 — Отступ в ShiftSummary
- После добавления `triggered_flag` нарушился таб-отступ (лишний таб перед строкой), из-за чего Godot увидел `if` на уровне класса и падает.
- Нужно поправить отступы внутри блока `if not report.is_empty():`, чтобы объявления находились в одной вложенности.

### 2025-12-22 — План: разделение interaction_engine на domain/legacy
1. Уточнить у пользователя: где должна жить доменная часть (оставить в `scripts/app/interaction` или перенести в `scripts/domain/interaction`), и нужен ли отдельный файл для схемы событий/пейлоадов.
2. Вынести legacy-ветку `_process_with_target` в адаптерный файл (например, `scripts/wardrobe/interaction_engine_legacy.gd`) и привязать её к существующему `WardrobeInteractionTarget`.
3. Создать общий модуль констант событий/результата (например, `scripts/domain/interaction/interaction_event_schema.gd`) и обновить импорты в UI/системах/тестах.
4. Обновить unit-тесты на новые пути/константы и проверить, что контракт событий не изменился.
5. Прогнать GdUnit4 наборы для interaction и desk сервисной точки, затем зафиксировать результаты в заметке и при необходимости обновить документацию.

## PLANNING: AESTHETICS AND DESIGN
_(опционально, если нужны визуальные/стилистические заметки)_

## CODING / VERIFICATION NOTES
_(ключевые шаги и проверки после реализации)_

### 2025-12-22 — Verification: interaction-related unit tests
- Запустил GdUnit4: `./addons/gdUnit4/runtest.sh -a ./tests/unit/interaction_engine_test.gd`.
- Запустил GdUnit4: `./addons/gdUnit4/runtest.sh -a ./tests/unit/interaction_event_adapter_test.gd`.
- Запустил GdUnit4: `./addons/gdUnit4/runtest.sh -a ./tests/unit/desk_service_point_system_test.gd`.
- Все наборы прошли, но есть предупреждения о повторяющихся global class names и сообщение macOS про `get_system_ca_certificates`.

### 2023-12-16 — Обновлён AGENTS.md
- Добавлены требования: хранить заметки в `docs/notes`, язык задач — GDScript, стиль/инденты из context7, обязательные обновления документации, ссылка на context7 как основной источник.
- Проверено, что новые секции и буллеты присутствуют в `AGENTS.md`; дополнительных файлов менять не понадобилось.
- Обновлены правила использования context7 (всегда при генерации контента, исправлении ошибок и пользовательских запросах, связанных с работой программы; в остальных случаях — по усмотрению).
- Добавлено уточнение: контекст https://context7.com/godotengine/godot используем только в задачах, связанных с GDScript; для других языков — их собственные разделы context7.

### 2023-12-16 — Перевод AGENTS.md
- Все русскоязычные фрагменты (включая секцию про context7) переведены на английский.
- Проверено, что структура и требования документа не изменились.
### 2023-12-16 — Перевод AGENTS.md на английский
- Пользователь попросил переписать текущие инструкции `AGENTS.md` на английском языке.
- Нужно сохранить все правила/структуру, но перевести формулировки.

### 2023-12-16 — Конспект правил GDScript в AGENTS.md
- Прочитан `docs/gdscript_guidelines.md`, ключевые пункты сведены в краткий список и добавлены в секцию `## GDScript guidelines` файла `AGENTS.md`.
- Одновременно привёл секцию `Using MCP / References` к финальной английской формулировке (context7 для GDScript, другие языки — по необходимости).

### 2023-12-16 — Секция про версию Godot
- В `AGENTS.md` заполнен блок `## Godot Enguine Version`: указано, что проект ведётся на Godot 4.5 (stable), и добавлена ссылка на строку `config/features` в `project.godot`.
- Пользователю можно ссылаться на `project.godot:15`, где хранится текущий набор feature-флагов, чтобы увидеть версию, с которой был сохранён проект.

### 2023-12-16 — Коммиты: AGENTS и экспорт
- Нужно сделать два отдельных коммита: первый — для правок `AGENTS.md` и связанных документов, второй — для изменений в настройках экспорта (`export_presets.cfg`).
- Следует аккуратно проиндексировать только соответствующие файлы, чтобы пользовательские изменения вне задачи не попали в коммиты.

### 2023-12-16 — Коммиты выполнены
- Создан коммит `docs: update AGENTS guidelines` (вошли `AGENTS.md`, `docs/gdscript_guidelines.md`, `docs/notes/task_analysis.md`).
- Создан коммит `chore: update export presets`, содержащий изменения только в `export_presets.cfg`.

### 2023-12-16 — Просьба: сквош последних двух коммитов
- Нужно объединить коммиты `docs: update AGENTS guidelines` и `chore: update export presets` в единый коммит.

### 2023-12-16 — Сквош выполнен
- Через `git reset --soft HEAD~2` + `git commit` создан единый коммит `chore: unify AGENTS updates and export presets`.
- При этом убедился, что сторонние изменения (например, `docs/project.md`) остались вне stage.

### 2023-12-16 — Вопрос по headless-билдам
- Нужно ответить, как собирать Godot-проекты (несколько конфигураций) без открытия UI, через CLI.

### 2023-12-16 — Проблема: бинарь Godot отсутствует в PATH
- Пользователь уточнил, что имеющийся бинарь `/Applications/Godot.app/.../Godot` не попадает в `$PATH`, а команда `godot4` недоступна.
- Решение (добавить путь в `~/.zshrc` или alias) отработало.

### 2023-12-16 — Настройка headless-билда для Web (itch), Web (local), macOS
- Нужно описать конкретные команды `Godot --headless --export...` для трёх пресетов: `"Web (itch.io)"`, `"Web (local)"`, `"macOS"`.
- Пользователь уточнил: использовать имя бинарника `godot4`; Web (itch.io) собирать релизом, а `Web (local)` и `macOS` — в debug-варианте.

### 2023-12-16 — Конфигурация для `just`
- Требуется добавить в репозиторий `justfile`, который автоматизирует сборку всех трёх пресетов.
- В рецептах нужно использовать ранее обсуждённые команды `godot4 --headless --export-*`.

### 2023-12-16 — `justfile` готов
- Добавлен `justfile` в корне проекта.
- Задачи `web-itch`, `web-local`, `mac-debug` создают выходные каталоги и вызывают `godot4 --headless` с нужными пресетами/флагами; `build-all` зависит от всех трёх.

### 2023-12-16 — Архивация Web (itch.io)
- Нужно дополнить задачу `web-itch` в `justfile`: после экспорта собирать файлы в zip-архив и удалять исходный каталог.

### 2023-12-16 — Архивация добавлена
- `web-itch` теперь архивирует сборку (`zip -r ../web_itch.zip .`) и удаляет временную папку.

### 2023-12-16 — Требование: save-and-clear
- Нужно завести папки `builds/current` и `builds/archive`.
- При каждой сборке заново наполняем `current` (старая сборка затирается).
- Команда `save-and-clear` должна сохранять `current` в zip архив внутри `archive` с постфиксом `_YYMMDD_hhmmss`, затем очищать `current`.

### 2023-12-16 — Реализация save-and-clear
- Цели `web-itch`, `web-local`, `mac-debug` теперь собирают в `builds/current/...` (предварительно очищая прежние артефакты).
- Добавлена цель `save-and-clear`, архивирующая `builds/current` в `builds/archive/build_YYMMDD_hhmmss.zip` и удаляющая содержимое `current`.

### 2023-12-16 — Проблема: `godot4` недоступен для just
- Alias `godot4` не доступен внутри рецептов `just`, поэтому команды падают с `command not found`.
- Нужно указать явный путь к бинарю или сделать переменную `GODOT_BIN` с дефолтным значением.

### 2025-12-16 — Подход к оформлению TDD
- Перед созданием нового файла убедиться, что структура разделов соответствует исходному тексту и использовать заголовки `# / ## / ###` для сохранения иерархии.
- План: сверстать документ блоками (платформа, архитектура, данные, FSM, события, подсистемы, UI, MVP, сохранения, риски, план итераций), добавив горизонтальные разделители там, где они были в оригинале.
- После генерации документа перепроверить списки и коды (например, перечисления команд) на корректный markdown, затем обновить `docs/project.md`, чтобы сослаться на новый файл.

### 2025-12-16 — Документ TDD создан
- На основе предоставленного текста добавлен `docs/technical_design_document.md` с полным переносом разделов 0–11, сохранением заголовков, списков, цитат и код-блоков.
- Пересобраны маркированные/нумерованные списки для читабельности, ссылки и инлайн-форматирование приведены к markdown-стилю (курсив, кодовые блоки, горизонтальные разделители).
- В `docs/project.md` добавлен блок «Дополнительная документация» со ссылкой на новый документ.

### 2025-12-16 — Проверка документации
- Просмотрены `docs/technical_design_document.md` и `docs/project.md`, чтобы убедиться в отсутствии опечаток, нарушенной иерархии заголовков и лишних символов.
- Контент соответствует исходному TDD, вложенные списки корректно отображаются (tabs использованы только для подуровней).
- Репозиторий содержит обновлённый журнал заметок, новых предупреждений или конфликтов нет.

### 2025-12-16 — Документация шага Project skeleton
- Создан подкаталог `docs/steps/` и файл `01_project_skeleton.md`, куда перенесены инструкции пользователя с адаптированными заголовками, списками и акцентами.
- В начале файла добавлена ссылка на раздел 11 TDD, а в TDD (пункт 1 плана итераций) добавлен обратный линк на новую инструкцию.
- `docs/project.md` пока не менялся, поскольку ссылка на TDD уже присутствует; перекрёстные ссылки покрывают сценарий поиска документации по шагам.

### 2025-12-16 — Проверка шага Project skeleton
- Открыл `docs/steps/01_project_skeleton.md` и `docs/technical_design_document.md`, убедился, что ссылки работают и якорь раздела 11 указан корректно.
- Просмотрел списки/заголовки на предмет нарушенной иерархии и смешанных отступов — формат соответствует остальной документации.

### 2025-12-16 — Аудит неопределённого поведения
- Пользователь попросил найти участки в `docs/technical_design_document.md` и `docs/steps/01_project_skeleton.md`, где описано неопределённое поведение.
- Нужно сверить эти участки с текущей реализацией (autoload-скрипты, сцены, контент), понять, закрыто ли поведение кодом.
- Если реализация уже есть — уточнить документацию, иначе перечислить всё ещё неопределённые сценарии.

### 2025-12-16 — Аудит: уточнение Step 1
- Обновил раздел C шага 1: описал фактическое поведение `RunManager` (инициализация Input Map, загрузка меты, демо-HUD и сохранение `total_currency`).
- В разделе D уточнил, что HUD подключается к сигналу `hud_updated` и сразу показывает снимок из `RunManager`, чтобы читателю было понятно, какие именно заглушки реализованы.

### 2025-12-16 — Аудит: проверка
- Просмотрел `scripts/autoload` и `scripts/ui`, убедился, что никаких `MagicSystem`/`Inspection`/других подсистем ещё нет — остаются только `RunManager`, `ContentDB`, `SaveManager`, `Debug`.
- Составил список оставшихся неопределённых сценариев из TDD (страховка, аварийный поиск, инспекции) для включения в ответ пользователю.

### 2025-12-16 — Обновление Magic/Inspection (Task Analysis)
- Пользователь хочет, чтобы TDD явно фиксировал конфигурируемые режимы MagicSystem и Inspection/Cleanliness, подчёркивая, что численные значения TBD.
- В коде нужно добавить заглушки MagicSystem/Inspection, хранить связанные счётчики в состоянии забега и предусмотреть переключатели режимов (по умолчанию: Insurance=FREE, Emergency=DEBT).
- Требуется обновить документацию (TDD +, при необходимости, Step 1) и привести RunManager/новые классы к таб-индентам и Godot стилю.

### 2025-12-16 — Coding: Magic/Inspection конфиги
- Обновлён `docs/technical_design_document.md`: уточнены `WardrobeRunState`, секции 6.6/6.8 и список MVP, добавлены режимы и пометки про TBD числа.
- В `docs/steps/01_project_skeleton.md` добавлено требование создать `magic_system.gd`/`inspection_system.gd`.
- Написаны заглушки `scripts/sim/magic_system.gd` и `scripts/sim/inspection_system.gd`, RunManager теперь хранит конфиг/счётчики и формирует отчёт для ShiftSummary, который тоже расширен.

### 2025-12-16 — Verification: Magic/Inspection
- Проверил, что новые скрипты используют табы, не требуют class_name для autoload и не создают предупреждений.
- Убедился, что HUD-долг обновляется при обработке аварийного поиска, а ShiftSummary показывает cleanliness/inspection данные (через payload).

### 2025-12-16 — Coding: унификация сохранений
- Привёл TDD (раздел 9) и Step 1 к схеме из двух файлов (`save_meta.json`, `save_run.json`).
- Обновил `SaveManager.gd`: введены константы `META_SAVE_PATH`, `RUN_SAVE_PATH`, кэш `DEFAULT_RUN`, методы `load_run_state/save_run_state/clear_run_save`, чтение/запись run-файла.

### 2025-12-16 — Verification: унификация сохранений
- Проверил, что все упоминания сохранений в TDD/Step 1 совпадают с кодом.
- Убедился, что новые методы SaveManager используют табы и не мешают существующему API (`clear_save()` теперь очищает оба файла).

### 2025-12-16 — Step 1 wording
- Уточнил формулировку для `RunManager` в Step 1: теперь пишем, что он инициализирует мету через `SaveManager` и подготавливает Input Map, без упоминания «ищет SaveManager».

### 2025-12-16 — Step 1 constraints for sim modules
- Добавил к Step 1 уточнение, что заглушки `magic_system.gd` и `inspection_system.gd` не зависят от `Node/SceneTree` и оперируют только данными (`WardrobeRunState + config`), чтобы их можно было тестировать отдельно и позже перенести в SimulationCore.

### 2025-12-16 — Variant inference warning (Task Analysis)
- Godot предупреждает: `var value := run_state.get(...)` в `inspection_system.gd` получает `Variant`, поэтому переменная остаётся типом Variant.
- Нужно привести к `float` (через явный каст или аннотацию) и зафиксировать правило в `docs/gdscript_guidelines.md` (добавить пункт про явные приведения после `Dictionary.get()`/`Variant`).

### 2025-12-16 — Coding: Variant inference fix
- В `scripts/sim/inspection_system.gd` явно привёл значения `cleanliness` и `inspector_risk` к `float`, чтобы переменные не оставались `Variant`.
- Обновил `docs/gdscript_guidelines.md`: добавлен пункт про обязательное приведение результата `Dictionary.get()` к ожидаемому типу.

### 2025-12-16 — Verification: Variant inference fix
- Просмотрел изменённые файлы, убедился, что табы сохранены и предупреждение IDE отсутствует (переменные получают `float` сразу).

### 2025-12-16 — AGENTS.md update
- В секции GDScript guidelines добавлю правило про явные приведения после `Dictionary.get()`/`Variant`, чтобы центральный документ тоже фиксировал найденный паттерн.

### 2025-12-16 — MagicSystem unused parameter
- Исправлен warning Godot: в `scripts/sim/magic_system.gd` параметр `run_state` не использовался, поэтому переименован в `_run_state` до фактического использования.

### 2025-12-16 — Ghost light rule (Task Analysis)
- Пользователь попросил зафиксировать механику призрачной одежды: предмет видим, но недоступен к взаимодействию, пока освещён.
- Нужно обновить TDD (разделы SpecialRulesSystem/PlacementSystem/данные) с описанием UX-фидбека, проверки в PlacementSystem и конфиг-параметров (`ghost_interaction_blocked_when_lit`, alpha, light_rule).
- Конфигурация освещённости должна оставаться гибкой (через зону или будущий LightSystem), симуляция не скрывает предмет, только блокирует операции.

### 2025-12-16 — Coding: Ghost light rule
- В `docs/technical_design_document.md` расширен раздел 3 (данные) новыми полями `ghost_interaction_blocked_when_lit`, `ghost_visibility_alpha_when_lit`, `light_rule`.
- В разделах 6.3/6.4 описаны проверки PlacementSystem и финальная механика Ghost (видимая одежда, блок операций при `is_lit`, UX-фидбек, presentation-first).
- В разделе 7.2 добавлен UX-требование (подсказки иконкой/текстом при наведении на освещённый предмет).

### 2025-12-16 — Verification: Ghost light rule
- Проверил документ на предмет нарушенных ссылок/индентов; новые пункты используют табы и согласованы с предыдущими описаниями SpecialRules/PlacementSystem/UX.

### 2025-12-16 — Baseline clothing rules (Task Analysis)
- Пользователь предоставил общие принципы для одежды (состояния, взаимодействия, порча, UX) и отдельные требования для обычной, зомби- и вампирской одежды.
- Нужно обновить TDD (данные, SpecialRules, UX) с этими описаниями и параметрами (`zombie_infect_radius`, `zombie_infect_rate`, `vampire_light_damage_rate`, пороги `condition_threshold_*`, enum `light_rule`/`proximity_rule`).
- Численные значения остаются TBD, конфиг сохраняет data-driven подход.

### 2025-12-16 — Clothing card UX (Task Analysis)
- Нужно добавить в TDD (раздел UI/UX) подпункт про карточку предмета: когда появляется, что не показывает (нет идентичности и текстовых правил), визуальная структура (спрайт + слои + анимации), звёздный рейтинг как единственный числовой индикатор (формула TBD).

### 2025-12-16 — Coding: Clothing card UX
- В `docs/technical_design_document.md` добавлен подраздел 7.4 про карточку одежды (триггер, запреты на идентичность и текстовые правила, визуальные слои/эффекты, звёздный рейтинг как единственный числовой индикатор).

### 2025-12-16 — Verification: Clothing card UX
- Проверил, что новый подраздел использует таб-отступы и не нарушает нумерацию разделов.

### 2025-12-16 — Hydra archetype (Task Analysis)
- Нужно описать правила архетипа “Гидра” в TDD: цели, поведение при drop-off (N предметов, один номерок, bundle_id), хранение (без ограничений), pick-up (обслуживание закрывается после выдачи всех N, допускается частичная выдача), ошибки (неполный набор, чужой предмет, повреждения), сводку, UI-фидбек, взаимодействие с магией (страховка/аварийный поиск масштабируются по N), конфиги (bundle_min/max, патчи на терпение/штрафы/стоимость магии).

### 2025-12-16 — Coding: Hydra archetype
- В `docs/technical_design_document.md` добавлены поля `bundle_id`, `bundle_size`, клиентские коэффициенты (`bundle_patience_multiplier`), описаны конфиги hydra (`bundle_min_items`, `bundle_max_items`, `bundle_wrong_item_penalty_multiplier`, `magic_cost_multiplier_per_bundle_item`).
- В разделе SpecialRulesSystem подробно описана гидра: как сдаёт набор, хранение без ограничений, условия pick-up, ошибки/сводка, UI-фидбек и взаимодействие со страховкой/аварийным поиском.

### 2025-12-16 — Verification: Hydra archetype
- Проверил, что новый текст следует таб-инденции и сочетается с описаниями других архетипов; поля `bundle_*` согласованы с данными и конфигами.

### 2025-12-16 — Inconsistencies: scenes & rules (Task Analysis)
- Step 1 не создаёт `ModifierSelect.tscn`, хотя TDD считает её базовой сценой; нужно либо добавить сцену в шаг, либо убрать из списка базовых сцен (до шага 7).
- Раздел 6.4 содержит дубли для Baseline/Hydra; нужно оставить один блок, убрать лишние упоминания.
- Описание Ghost конфликтует (“невидимость” vs “видим”); надо переписать как “видим, но нельзя взаимодействовать при `is_lit=true`”.
- Уточнить, что `light_rule`/`proximity_rule` в коде превращаются в enum/константы (string — формат файла), и что проверка света смотрит на слоты (source/target).
- Добавить в TDD, что rule-поля в Item могут храниться как кэш/ссылка на конфиг, источник истины — данные.

### 2025-12-16 — Coding: inconsistencies fix
- Step 1 теперь явным образом создаёт `ModifierSelect.tscn`-заглушку.
- В TDD очищены дубли (Baseline/Hydra), переписан блок Ghost (только про блокировку действий), добавлены пояснения про enum-парсинг, источник правил и проверку `is_lit` по слотам.

### 2025-12-16 — Verification: inconsistencies fix
- Просмотрел Step 1 и TDD — противоречий по сценам нет, раздел 6.4 читабелен, правила света описаны единообразно.

### 2025-12-16 — Hydra postpone & Ghost UX (Task Analysis)
- Hydra должна остаться вне MVP: подробный блок из “вертикального среза” переносим в раздел “Расширение”, удаляем дублирующие строки про Baseline/Hydra.
- Ghost UX: никаких подсказок/иконок до попытки действия — оставляем только визуальный фидбек отказа при блокировке.
- В PlacementSystem нужно явно сформулировать, что проверка света работает по source/target slot (slot-first wording).

### 2025-12-16 — Coding: Hydra postpone & Ghost UX
- Перенёс подробный блок Hydra из вертикального среза в “Расширение”, удалил повторные строки про Baseline/Hydra, оставив единый источник (Hydra теперь явно отложена).
- Описание Ghost теперь говорит только “видим, но действия запрещены при `is_lit`”, без подсказок до попытки; в разделе 6.3 подчёркнуто slot-first поведение.

### 2025-12-16 — Verification: Hydra postpone & Ghost UX
- Просмотрел обновлённые разделы 6.3/6.4 и Step 1: линк на ModifierSelect есть, Hydra не конфликтует с списком MVP, текст консистентен.

### 2025-12-16 — Fix: slot check wording
- В 6.3 заменил остаточное `is_item_lit` на `is_slot_lit(source_slot/target_slot)` и убрал упоминание “предмета в руках”.

### 2025-12-16 — Step 1 ModifierSelect implementation
- Добавлены `scenes/screens/ModifierSelect.tscn` и `scripts/ui/modifier_select.gd`: простой placeholder с кнопкой `Continue`, которая через RunManager возвращает игрока в меню (пока модификаторы не реализованы).
- `scripts/ui/main.gd` теперь знает о сцене `modifier_select`, чтобы будущие вызовы `screen_requested` могли её показать.

### 2025-12-16 — Fix: vampire vs ghost light rules
- Текст 6.3 дополнен уточнением, что Ghost трактуется как `INTERACT_BLOCK`, а Vampire — как `DAMAGE` (свет запускает порчу, но не блокирует действия).

### 2025-12-16 — Ghost UX hint rule
- В TDD уточнил: единственный допустимый намёк до действия — изменение альфы (`ghost_visibility_alpha_when_lit` с диапазоном 0..1, дефолт TBD ~0.7); текст/иконки/маркер “заблокировано” запрещены до попытки.
- При попытке действия в освещённом слоте фиксируем блокировку + VFX, как и прежде.

### 2025-12-16 — Ghost alpha range
- Диапазон `ghost_visibility_alpha_when_lit` в обоих местах TDD унифицирован: 0..1 с рекомендуемым диапазоном 0.5–0.8 (дефолт TBD ≈0.7).

### 2025-12-16 — Web persistence note
- В TDD (разделы 1.4 и 9.2) добавлен комментарий: `user://` на Web зависит от IndexedDB/cookies/iframe, поэтому нужно проверять `OS.is_userfs_persistent()` и учитывать риск потери данных при закрытии вкладки.

### 2025-12-16 — Web export mode note
- Раздел 1.3 TDD уточнён: по умолчанию собираем Web single-thread (без SharedArrayBuffer/COOP-COEP), чтобы не конфликтовать с itch/web publisher’ами; multi-thread потребует отдельной настройки.

### 2025-12-16 — C# vs Web note
- В разделе 1.2 TDD добавлено пояснение: Godot 4 не экспортирует C#-проекты в Web, поэтому язык разработки фиксирован как GDScript (никакого “немного C#”).

### 2025-12-16 — Ghost reactive feedback note
- Раздел 6.4 уточняет формулировку: у Ghost нет превентивных подсказок; при блокировке действий проигрывается краткий реактивный VFX/звук (feedback only on action).

### 2025-12-16 — Ghost/Hydra tech vs UX separation
- Раздел 6.4 TDD теперь разделяет “Технические требования” и “UX намерение” для Ghost/Hydra: инварианты остаются в техблоке, а визуальные идеи явно отмечены как опциональные/изменяемые.

### 2025-12-16 — SimulationCore structure note
- В разделе 6.1 TDD зафиксировано техническое решение: SimulationCore — чистый класс (не Node), вызываемый из RunManager/WardrobeScene, чтобы сохранить тестируемость и простоту переноса.

### 2025-12-16 — Несостыковка по сохранениям (Task Analysis)
- Пользователь заметил расхождение: в TDD (`user://save.json`) и Step 1/коде (`user://save_meta.json`).
- Выбрана единая схема: **два файла** (`user://save_meta.json` и `user://save_run.json`), где meta постоянный блок, а run опционален и может быть пустым до реализации.
- Нужно обновить TDD, Step 1 и SaveManager (константа + заглушки run-save), чтобы все документы ссылались на единую схему.

### 2025-12-16 — Coding: RunManager debt type fix
- В `_process_emergency_cost()` заменил `var debt := ...` на `var debt: int = int(...) + value`, чтобы GDScript получил конкретный тип и смог скомпилировать автозагрузочный скрипт.
- Дополнительно просмотрел остальные обращения `_run_state.get(...)` и убедился, что они не объявляют новые переменные через `:=`, поэтому аналогичных ошибок нет.

### 2025-12-16 — Verification: RunManager debt type fix
- Повторно проверил `scripts/autoload/run_manager.gd`, убедился, что табы сохранены, а единственная критичная строка теперь использует явный `int(...)`.
- Поищал остальные места с `_run_state.get` через `rg` — parse issues больше не обнаружены, значит билд должен грузить автозагрузку без ошибок.

### 2025-12-16 — Coding: ShiftSummary UI и кнопка
- В `scripts/ui/shift_summary.gd` добавил флаг `_is_ready`, чтобы `apply_payload()` не вызывал `_refresh()` до инициализации `@onready` узлов; `_refresh()` теперь проверяет наличие `Label`, а `_ready()` подключает кнопку с защитой.
- Добавил ленивый `_ensure_run_manager()`, который повторно ищет singleton перед возвратом в меню — кнопка `Back to Menu` теперь работает даже если автозагрузка ещё не была найдена в `_ready()`.

### 2025-12-16 — Verification: ShiftSummary UI и кнопка
- Проверил скрипт: табы сохранены, `get_node_or_null` вызывается только когда нужно, `_summary_label` не обращается преждевременно.
- Логически прошёл путь `MainMenu → Wardrobe → End Shift → ShiftSummary → Back to Menu`: экран получает payload после `_is_ready`, а кнопка найдёт `RunManager` нажатиями.

### 2025-12-16 — Coding: отказ от `?:` + обновление гайдов
- Переписал строку с `report.get("triggered", false) ? ...` в `scripts/ui/shift_summary.gd`, теперь используется `"Yes" if triggered_flag else "No"` и переменная `triggered_flag` для читаемости.
- Добавил правило про GDScript-тернарный синтаксис в `docs/gdscript_guidelines.md` и продублировал пункт в секции `## GDScript guidelines` (`AGENTS.md`), чтобы напоминание присутствовало в обоих источниках.

### 2025-12-16 — Verification: отказ от `?:` + обновление гайдов
- Убедился, что новый код использует табы, `triggered_flag` объявлен через `:=`, и строка не содержит запрещённого `?`.
- Просмотрел оба документа, проверил, что новые пункты корректно оформлены и не ломают нумерацию списков.

### 2025-12-16 — Coding: приведение triggered_flag
- В `scripts/ui/shift_summary.gd` теперь `var triggered_flag: bool = bool(report.get("triggered", false))`, что соответствует правилу про Variant → ожидаемый тип.

### 2025-12-16 — Verification: приведение triggered_flag
- Пересмотрел файл, убедился, что предупреждений IDE больше нет и табы соблюдены; других переменных с `:= report.get` в файле не осталось.

### 2025-12-16 — Coding: отступ
- Исправил лишний таб перед строкой с `triggered_flag`, теперь блок `if not report.is_empty():` содержит все строки на одинаковом уровне вложенности.

### 2025-12-16 — Verification: отступ
- Повторно посмотрел файл через `nl`, убедился, что структура корректна и Godot больше не жалуется на «Unexpected if in class body».

### 2025-12-16 — Coding: сквош последних коммитов
- Через `git reset --soft HEAD~2` вернул изменения двух свежих коммитов в индекс.
- Снова проиндексировал все файлы и создал единый коммит `Document systems and add Modifier Select scaffolding`.

### 2025-12-16 — Verification: сквош последних коммитов
- Проверил `git log -2 --oneline`, убедился, что остался один новый коммит поверх `add just makefile`.
- `git status` показывает чистое дерево, значит история выглядит как ожидалось.
