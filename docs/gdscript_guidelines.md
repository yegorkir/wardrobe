# GDScript Guidelines for «Магический гардероб»

Ниже — правила, которые оформлены на основе всех проблем, с которыми мы уже успели столкнуться при настройке скелета проекта. Соблюдайте их, чтобы ускорить ревью, избежать повторяющихся ошибок и поддерживать чистый автокомплит в Godot.

---

## 1. Autoload’ы

1. **Не используем `class_name`** в скриптах, подключённых через Project Settings → Autoload. Глобальное имя вызывает конфликт (`Class "X" hides an autoload singleton`).
2. **Получаем ссылки через `/root/...`** только когда автолоад гарантированно загрузился. Используйте `get_node_or_null("/root/SingletonName")` и проверяйте результат перед использованием.
3. **Нет прямых ссылок по имени класса.** После удаления `class_name` у автолоадов IDE не знает тип, поэтому типизированные ссылки заменяем на `:= get_node_or_null(...)` + проверки и `push_warning(...)`.

## 2. Работа с Input Map и сигналами

1. **Константы Godot 4.** Используйте `KEY_ESCAPE`, `KEY_F1`, `MouseButton.MOUSE_BUTTON_LEFT` — старые `Key.ESCAPE` или `MouseButton.LEFT` не существуют в Godot 4.x.
2. **Auto-wiring**: подключайте сигналы (`RunManager.screen_requested.connect(...)`) только после проверки, что нужный singleton найден.

## 3. Типы и работа с Variant

1. **Явный тип при парсинге JSON.** Любой вызов `JSON.parse_string()` сохраняем в переменную `var parsed: Variant = ...`, чтобы устранить предупреждения IDE.
2. **Typed переменные, когда реально можно.** Например, HUD-ссылки (`var _wave_label: Label = ...`) помогают автокомплиту, но для автолоадов оставляем `:=`.
3. **Клон словарей**: при отдаче снапшотов (`return _hud_snapshot.duplicate(true)`) всегда возвращаем копии.

## 4. Навигация по сценам и UI

1. **Центральный диспетчер экранов.** `Main.gd` единственный файл, который создаёт/освобождает экраны. Остальные сцены не грузят друг друга напрямую.
2. **`apply_payload` опционален.** Перед вызовом `apply_payload` проверяем `has_method(...)`.
3. **HUD/сигналы отсоединяем в `_exit_tree`.** Следим, чтобы `RunManager.hud_updated.disconnect(...)` вызывался, только если связь была создана.

## 5. Индентация и стиль

1. **Автолоды и логика** — табы (`\t`). Используем табы по всему проекту, не заменять на пробелы.
2. **Кодовые комментарии** — только там, где блок сложно прочитать. Избегаем комментариев «в лоб».

## 6. Безопасность и сохранения

1. **RunManager всегда проверяет SaveManager.** `_save_manager = get_node_or_null("/root/SaveManager")` + предупреждение, если автолоад не найден, чтобы игра не падала.
2. **SaveManager не ловит ошибки на `FileAccess` silently.** Если файл отсутствует — логируем `SaveManager: no save found`.

## 7. Работа со структурой

2. **Любые правки логики проекта сопровождаем обновлением `docs/project.md`.** Документация должна отражать текущее состояние.
3. **Обновляем файл `gdscript_guidelines.md` при находжении новых правил работы с GDScript.**

## 8. Диагностика и предупреждения

1. Если Godot или godot-tools даёт предупреждение — фиксируем, не подавляем.
2. `push_warning(...)` используем для всех узлов, которые должны существовать, но могут отсутствовать (например, автолоады в ранних билдах).

---

Следуя этим правилам, мы избегаем основных ловушек Godot 4 и держим код опрятным. Если возникает новый повторяющийся паттерн ошибок — обновляем этот файл, чтобы следующие задачи делались быстрее.
