# Task: Shift Win (MVP)

## Контекст (что уже есть)

* Смена может завершиться вручную (debug End Shift) и по fail-условиям (страйки/патience=0).
* Есть `ShiftService` и `WardrobeShiftLog`, которые должны быть источником истины для итогов смены.
* UI (экраны/сцены) только отображает состояние и не решает правила завершения.

## Цель итерации

Добавить **детерминированное правило победы смены** и события так, чтобы:

* `ShiftService` решал, когда смена выиграна.
* UI только реагировал на статус/событие.
* `ShiftSummary` получал финальный статус из логов/снимков, а не из текстовых меток UI.

## Non-goals (что НЕ делаем)

* Не меняем правила поражения (страйки/патience=0).
* Не меняем экономику/чаевые/штрафы.
* Не делаем баланс чисел/таймингов волн.
* Не перепридумываем спавнер/очередь клиентов.

---

## Архитектурные требования (guardrails)

1. **SSOT в app/domain:** статус смены (running/success/failed) хранится в `ShiftService`.
2. **Commands in / Outcomes out:** победа оформляется как outcome-событие в ShiftLog.
3. **Идемпотентность:** повторный триггер победы не должен переигрывать завершение смены.
4. **UI-пассивен:** экраны не решают, что смена выиграна; только читают статус.

---

## Требуемая логика (поведение системы)

### 1) Условие победы

Смена считается **выигранной**, когда одновременно выполнены условия:

* Все клиенты плана/волны обслужены **и** больше нет активных клиентов.
* Нет активных reject-обработок, которые ещё могут изменить исход (например, незавершённый checkout).
* Смена не в состоянии `FAILED`.

> Конкретные источники фактов должны использовать уже существующие структуры (ShiftService / wave tracker / ShiftLog). UI не должен вычислять это сам.

### 2) Переход в success

* При выполнении условий победы `ShiftService` переводит смену в статус `SUCCESS`.
* `ShiftService` эмитит событие `SHIFT_WON` (или эквивалент) в ShiftLog.
* EndShift вызывается **через единую точку входа**, чтобы избежать дублирующих переходов.

### 3) Отчёт/summary

* `ShiftSummary` строится из `ShiftService` snapshot + ShiftLog.
* В summary должны быть:
  * `status = SUCCESS/FAILED/RUNNING`
  * причины завершения (минимум: `SHIFT_WON` или `SHIFT_FAILED`)

---

## План работ (пошагово, маленькими кусками)

### Step 1 — Найти текущий источник данных

* Где хранится прогресс волны/плана клиентов.
* Где хранится факт активных клиентов.
* Где уже вызывается `end_shift()` (авто и debug).

**DoD Step 1:** перечислены и понятны 3 источника данных, где можно взять факты для win-условия.

---

### Step 2 — Политика победы (app-слой)

* В app-слое добавить политику/метод `can_win_shift(...)`.
* Метод должен быть чистым: вход = факты, выход = true/false + причина.

**DoD Step 2:** unit-тесты минимум на 3 кейса:
1) все обслужены + нет активных → win,
2) есть активный клиент → no win,
3) status failed → no win.

---

### Step 3 — Переход в статус SUCCESS

* В `ShiftService` добавить единый метод `try_finish_shift_success()`.
* Метод:
  * проверяет `can_win_shift`,
  * ставит статус `SUCCESS` **один раз**,
  * пишет событие в ShiftLog.

**DoD Step 3:** повторный вызов не дублирует событие и не меняет результат.

---

### Step 4 — Интеграция в ход смены

* Встроить `try_finish_shift_success()` в стандартный цикл (после обслуживания клиента/волны).
* Убедиться, что debug EndShift и авто fail используют одну точку завершения.

**DoD Step 4:** при победе смена завершается так же, как и при ручном EndShift (без дублирующих путей).

---

### Step 5 — UI + ShiftSummary

* UI подписывается только на статус/summary (не решает win сам).
* `ShiftSummary` показывает статус `SUCCESS` и причину `SHIFT_WON`.

**DoD Step 5:** визуально видно, что победа отражена в summary, без доп. логики в UI.

---

## Acceptance Criteria (итоговые)

1. Победа определяется по фактам состояния в `ShiftService`, без вычислений в UI.
2. Повторные события (клики/тики) не дублируют завершение смены.
3. Статус SUCCESS и `SHIFT_WON` видны в ShiftSummary.
4. Fail-логика (страйки) не сломана и имеет приоритет над win.

## Мини-набор тестов/проверок

* Unit: `can_win_shift` policy (3 кейса минимум).
* Integration: “обслужены все клиенты → SUCCESS”.
* Regression: fail по страйкам всё ещё завершает смену и не вызывает SUCCESS.
* Smoke: EndShift вручную всё ещё работает.
