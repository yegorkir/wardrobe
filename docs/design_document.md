# Полный дизайн-док v0.4 (спека)

Ниже — “как должно быть” по последним твоим фиксациям. Формат:

* **[MVP-FIX]** — обязано быть в MVP.
* **[OPEN-PLAYTEST]** — делаем/пробуем, но считаем тюнингом.
* **[PLAN]** — после MVP.

---

## 3.1. Коротко о проекте

**Жанр/ядро:** визуальный менеджмент + пространственный пазл с умеренным стрессом.
**Формат MVP:** один экран, без персонажа; основной UX — drag-and-drop + click/tap.
**Тон:** “уютный хаос”; комедия как следствие **ошибок управления**, а не шуток текстом.

**Пояснение:** если игрок сам создал себе катастрофу (не тот номерок, не туда положил, завалил стойку), это повышает реиграбельность: “в этот раз я погиб по-другому”.

---

## 3.2. MDA (зафиксировано)

### Aesthetics (топ-3)

1. **Challenge** — главная ценность.
2. **Discovery** — игрок учится читать правила руками, без текста.
3. **Sensation** — уют/атмосфера как цель, но без упора в дорогую продакшн-красоту на раннем MVP.

**В запасе:** **Expression** (самовыражение через порядок).

**Пояснение:** Discovery здесь не “обучалка”, а удовольствие от “я понял систему”. Expression держим как бонус, чтобы не раздувать MVP в симулятор перфекциониста.

---

### Dynamics (желаемые паттерны)

**Топ-решения игрока:**

* кого обслужить сейчас (2 слота),
* где хранить,
* когда идти в риск (исправлять хаос под давлением).

**Источники напряжения:**

* patience/время,
* типы клиентов (разные штрафы/темп),
* взаимодействия предметов/окружения (свет/порча/падения).

**“Хорошая игра мастера” (планка качества):**

* игрок умеет **восстанавливаться после ошибок** (траблшутинг),
* “идеальная раскладка” не стабильна: поток клиентов/возвратов её ломает.

**Пояснение:** как в тетрисе — ошибки допустимы, но каждая приближает к поражению, если не умеешь разгребать.

---

### Mechanics (минимум правил MVP)

Дальше — конкретика.

---

## 3.3. Сцена, зоны и объекты

### 3.3.1. Экран и зоны

**[MVP-FIX]** Один экран: **Storage Hall** + **Service Desk Zone** + **Floor**.

* **Service Desk Zone:** 2 слота обслуживания (A и B).
* **Storage Hall:** шкафы/крючки/полки, плюс источники света (шторы/лампы).
* **Floor:** место падений и “последней инстанции”.

**Пояснение:** игрок всегда видит причины/следствия — это ключ к “без текста”.

---

### 3.3.2. Геометрия Storage Hall и свет как сущность

**[MVP-FIX]** Источники света — сущности с одинаковой логикой “включено/выключено”, отличающиеся только зоной освещения:

* **Шторы:** освещают **левый + центральный столбец** (большая зона).
* **Лампы:** освещают **часть правого столбца** (сегментарно по рядам/зонам).

**[OPEN-PLAN]** Возможная будущая версия: центральный столбец делится пополам (левая половина от штор, правая — от ламп), чтобы заставить микро-перестановки внутри ряда.

**Пояснение:** свет должен быть очевидным визуально (заливка/луч/яркость окружения), иначе плейтестеры скажут “баг”.

---

## 3.4. Предметы

### 3.4.1. Базовые свойства предмета

**[MVP-FIX]** Каждый предмет имеет:

* **вид (sprite)**,
* **качество** (звёзды, дискретно),
* **тип/архетип** (обычный / вампирский / зомби / призрачный / хрупкий и т.п.),
* **принадлежность** клиенту (внутренняя инфомодель).

**Пояснение:** без текста игрок считывает предмет по виду + звёздам + визуальным эффектам порчи.

---

### 3.4.2. Качество (звёзды)

**[MVP-FIX]** Звёзды могут **только падать** в MVP.
**[PLAN]** Восстановление звёзд — отдельная будущая механика (хотелка).

**Пояснение:** “необратимость” — главный двигатель снежного кома.

---

### 3.4.3. Падения = общий источник урона качеству

**[MVP-FIX]** Любое падение на пол — “обычное падение” и может снизить качество.
**[OPEN-PLAYTEST]** Формула вероятности/величины урона:

* чем выше качество — тем “обиднее” падение,
* “хлам” теряет качество слабее,
* **хрупкие** предметы: позже добавляем зависимость от высоты/шанса разбиться.

**Пояснение:** нельзя заводить “безопасные падения” — игрок быстро начнёт эксплойтить.

---

## 3.5. UX drag-and-drop (обязательные правила)

### 3.5.1. Рука и перенос

**[MVP-FIX]** В руке одновременно **1 предмет**.

**Пояснение:** это держит читаемость и делает ошибки игрока “его руками сделанными”.

---

### 3.5.2. Chameleon preview

**[MVP-FIX]** Предмет в руке:

* над Storage Hall **сжимается** (чтобы не перекрывать цель),
* над Service Zone может быть **крупнее** (акцент на объекте).

**Пояснение:** это не косметика, это читабельность без текста.

---

### 3.5.3. Подсветка цели / снап

**[MVP-FIX]** При наведении:

* подсветка/снап “куда положится” (слот/полка/поверхность),
* визуально различаем “я над крючком” vs “я над полкой”.

**Пояснение:** игрок должен понимать контекст дропа за 1 секунду.

---

### 3.5.4. Валидация и наказание

**[MVP-FIX]** Если игрок отпускает предмет:

* **если есть валидная цель** → пытаемся разместить,
* **если цель невалидна** → **падение на пол**,
* **если цель валидна, но предмет не влез/сорвался (полка)** → тоже падение на пол.

**Пояснение:** предмет не должен “исчезать”. Наказание должно быть физическим и понятным.

---

### 3.5.5. Операции взаимодействия по типам мест

**[MVP-FIX]**

* **Стойка:** PICK / PUT
* **Крючки:** PICK / PUT
* **Полки:** PICK / PUT
* **Пол:** PICK / PUT (поднять/бросить)

**Пояснение:** SWAP отключён в MVP, чтобы отпускание всегда означало “положить или уронить”, без скрытой замены предметов.

---

## 3.6. Клиенты и двухфазная модель

### 3.6.1. Фазы клиента

**[MVP-FIX]** У каждого клиента есть 2 фазы:

1. **Check-in (сдача вещей)**
2. **Check-out (возврат вещей)**

**Пояснение:** это создаёт “точку невозврата” и долгосрочные последствия ошибок.

---

### 3.6.2. items_per_client

**[MVP-FIX]** `items_per_client` задаётся **конфигом клиента**.
В текущем MVP-срезе реализации может быть 1, но система должна поддерживать >1.

**Пояснение:** масштабирование сложности проще делать контентом/конфигом, чем переписыванием логики.

---

### 3.6.3. Check-in: выкладка и номерок

**[MVP-FIX]** Клиент выкладывает предмет(ы) на стойку **“кучей”** (хаотично, одним действием; даже если предмет один — это не “в ячейку”).
Игрок:

1. забирает предметы и раскладывает в Storage Hall,
2. кладёт номерок на стойку.

**[MVP-FIX]** Как только клиент **видит номерок**, он **забирает его сразу**, даже если на стойке ещё остались его вещи.

**Пояснение:** это намеренно позволяет игроку самому создать “производственный ад” (вещи остались, а связь уже зафиксирована).

> ⚠️ Примечание к текущему коду среза: сейчас стойка/логика больше похожа на “слот + swap”. Если ты хочешь “кучу” именно в MVP, это требует апгрейда стойки до surface-модели.

---

### 3.6.4. Инфомодель связей

**[MVP-FIX]**

* Игра хранит связь **Client ↔ Ticket**.
* Игра хранит список вещей клиента (bundle).
* На check-out идёт проверка: “эта вещь принадлежит этому клиенту”.

**Пояснение:** иначе “без текста” превращается в “без правил”.

---

### 3.6.5. Check-out: выдача по одной

**[MVP-FIX]** Клиент приходит с номерком.
Игрок выкладывает вещи клиента на стойку.
**Каждую правильную вещь** клиент **забирает сразу**, но уходит только когда получил **все** вещи.

**Пояснение:** поштучный разбор снижает “непонятно что происходит” и делает ошибки локальными.

---

### 3.6.6. Ошибка на check-out (wrong item)

**[MVP-FIX]** Если игрок кладёт клиенту **чужую вещь**:

* клиент **выталкивает её на пол**,
* клиент теряет **patience** на величину, зависящую от типа клиента,
* падение на пол считается **обычным падением** и может снизить качество (**D1**).

**Пояснение:** это “сам себя наказал” без ощущения, что игра вредничает.

---

## 3.7. Patience и анти-игнор

### 3.7.1. Patience как ресурс

**[MVP-FIX]** У каждого клиента:

* своё `patience_max`,
* своя скорость убывания (позже/через конфиг).

**[PLAN]** Убывание в очереди — отдельной скоростью (плейтестить).

---

### 3.7.2. Patience=0 (строго)

**[MVP-FIX | B1]** `patience=0` блокирует **только свой слот** на стойке. Второй слот работает.
**[MVP-FIX]** Клиента с `patience=0` можно **дообслужить**: если выдать все его вещи, он завершит check-out и уйдёт (софтлока нет).
**[MVP-FIX]** В счётчик “увольнения” идёт только событие `patience: >0 → 0` (если пришёл уже с 0 — не считается).

**Пояснение:** наказание — потеря пропускной способности и деньги, а не “игра выключилась”.

---

### 3.7.3. Lose-условие на смену

**[MVP-FIX]** Проигрыш, если за смену произошло **3 страйка** (три раза `patience > 0` стало `0`).

---

## 3.8. Смена: win/lose, темп и очередь

### 3.8.1. Два счётчика прогресса смены

**[MVP-FIX]** Параметры смены задаются конфигом:

* `N_checkin` — сколько сдач нужно принять,
* `N_checkout` — сколько возвратов нужно выдать.

**[MVP-FIX]** Дефолт первого плейтеста: **6 / 4**.

**[MVP-FIX | E1]** Смена заканчивается, когда выполнены **оба** счётчика, **даже если на стойке/полу бардак**.

**Пояснение:** иначе плейтест будет спорить “почему я не победил”, а не “как мне играть лучше”.

---

### 3.8.2. Очередь без “таймера возврата”

**[MVP-FIX]** Есть два пула:

* `pool_checkin` — новые сдающие,
* `pool_checkout` — возвратники (формируется из тех, кто уже сдал).

**[MVP-FIX]** Мы **не фиксируем задержку возврата в секундах**. Вместо этого, когда освобождается место у стойки, спавнер выбирает, из какого пула дать следующего клиента.

**[MVP-FIX] Базовые ограничения выбора**

* если возвратников ещё нет → спавним check-in,
* если `N_checkin` выполнен → спавним только check-out,
* если `N_checkout` выполнен → спавним только check-in (редкий режим, но формально).

**[OPEN-PLAYTEST] Скоринг микса**

* `outstanding = checkin_done - checkout_done`
* `need_in = N_checkin - checkin_done`
* `need_out = N_checkout - checkout_done`
* `progress = (checkin_done + checkout_done) / (N_checkin + N_checkout)`

Идея:

* ранняя смена тяготеет к check-in,
* чем больше outstanding и чем ближе progress к 0.5–1.0, тем сильнее подмешиваем check-out,
* допускаем лёгкий рандом, чтобы не было “шахмат”.

**Пояснение:** это даёт “живой” поток гостей, а не театральные акты “сначала сдача, потом выдача”.

---

## 3.9. Порча и архетипы (Zombie / Vampire / Ghost)

### 3.9.1. Общие правила порчи

**[MVP-FIX]** Порча снижает качество (звёзды) и/или влияет на экономику.
**[MVP-FIX]** **Рука = безопасная зона:** пока предмет в руке, порча **не распространяется**.
**[OPEN-PLAN]** В руке можно оставлять VFX-шлейф (запах/частицы), но без механического эффекта.

---

### 3.9.2. Zombie-порча

**[MVP-FIX]**

* Zombie-предмет портит вещи в радиусе со временем.
* Порча идёт **стадиями**: копится “до порога”, при достижении — снимается часть качества (например, пол-звезды/звезда), затем начинается следующая стадия.
* **Если убрать источник**, сбрасывается **только накопление текущей стадии**, но потерянные звёзды **не возвращаются**.

**[MVP-FIX]** Порча от зомби и порча от света могут накладываться одновременно.

**[OPEN-PLAN]** Вторичные источники: если предмет достаточно испорчен, он сам начинает источать порчу (радиус растёт по стадиям).
**[OPEN-PLAN]** Суммирование нескольких источников (ускорение) — формула тюнинга.

**Пояснение:** игрок должен видеть “я не убрал источник вовремя → получил необратимый минус”, но иметь шанс успеть остановить до порога.

---

### 3.9.3. Vampire-порча от света

**[MVP-FIX]** Вампирские предметы портятся, когда находятся **в освещённой зоне** (шторы/лампы).

**[OPEN-PLAYTEST]** Правило “предмет в свету?”:

* вариант A: **pivot/центр** предмета внутри зоны света → считается в свету (рекомендовано как старт для тестов).

**Пояснение:** пиксель-пересечения дорогие и спорные; pivot игрок быстро выучит.

---

### 3.9.4. Ghost

**[MVP-FIX]** Ghost есть в MVP.
**[MVP-FIX | старт плейтеста]** Режим C: **в темноте предмет блеклый и его нельзя перемещать**, в свету — обычный.
**[OPEN-PLAYTEST]** Иконка “замок” как UI-хинт — пробуем, но легко выкидываем.

**Пояснение:** вариант “не видно, но можно двигать” слишком часто читается как баг.

---

### 3.9.5. UI порчи

**[MVP-FIX]** В ранней сборке допускаем **2 прогресс-бара разных цветов** (зомби/свет).
**[PLAN]** К концу MVP заменяем на **анимации порчи**, допускаем одновременное отображение двух причин.

**Пояснение:** прогресс-бар — костыль для тюнинга. Визуальная порча — “продукт”.

---

## 3.10. Anchor_ticket (якорный номерок)

### 3.10.1. Суть

**[MVP-FIX]** Anchor_ticket — способ связать **вещь/пачку вещей** с **местом хранения** (и/или с меткой на самой вещи).

**[OPEN]** Возможны две модели:

1. метка на зоне хранения,
2. метка на предмете (бирка).

---

### 3.10.2. Переназначение

**[MVP-FIX | A1]** Переназначение anchor_ticket доступно **только на стойке (Service Desk)**.
**[MVP-FIX]** Переназначение **платное временем** (каналинг/тайм-кост).
**[OPEN-PLAYTEST]** Ограничения (сколько раз за смену, можно ли только при наличии номерка/вещи и т.д.) — тюнинг.

**Пояснение:** иначе это станет “undo” в Storage Hall и убьёт последствия ошибок.

---

## 3.11. Экономика (в MVP — как минимум вектор)

**[MVP-FIX]** Цель игрока: **не быть уволенным** и **заработать больше**.

**[OPEN-PLAYTEST]** Черновой каркас:

* у клиента есть `tip_pool`,
* чаевые зависят от остатка patience и сохранённого качества,
* штрафы: события patience=0, разбитые/испорченные вещи, возможно клининг (позже).

**Пояснение:** игрок должен понимать “за что меня наказали” и “что делать иначе”.

---

## 3.12. “Не делаем в MVP” (антирасползание)

**[MVP-FIX]**

* ходьба персонажа / proximity / коллизии персонажа,
* сложная инспекция с жёсткими наказаниями (в MVP максимум “вектор”),
* большая нарративная подача и диалоги.

**Пояснение:** иначе MVP станет “всё сразу”, а плейтест — “ничего не работает”.

---

## 3.13. Главные OPEN после v0.4 (что реально требует плейтеста)

1. Формула микса очереди check-in/check-out.
2. Числа урона/падений и конверсия в звёзды.
3. Типозависимый штраф patience на wrong item.
4. Лимиты/стоимость anchor_ticket переназначения.
5. Ghost: режим C ок, но хинты (замок) — под вопросом.
