# Магический гардероб — дизайн‑док (актуальный канон) v0.6

> Принцип приоритета истины: **всё, что ниже помечено как [MVP-FIX], считаем каноном для ближайшего плейтеста**.  
> Всё, что помечено как **[OPEN] / [OPEN-PLAYTEST] / [POST-MVP-PLAN]** — обсуждаемо и может меняться.

---

## 0) Changelog v0.5 → v0.6 (патчи по последней фиксации)

- **[MVP-FIX] Win-condition смены**: цели **`N_checkin` и `N_checkout` задаются конфигом**, дефолт для 1-го плейтеста **6/4**.
- **[MVP-FIX] Fail-condition**: **strikes = 3** событий `patience: >0 → 0`. **Wave-таймер удалён** (не часть MVP).
- **[MVP-FIX] Check-in**: клиент **забирает ticket сразу, как только он появился на стойке**, независимо от того, остались ли его вещи на стойке.
- **[MVP-FIX] Surface‑стойка (Papers, Please‑like)**: хаос “ticket ушёл, вещи остались” **полноценно раскрывается после перехода на surface‑стол** (итерация 4.2).
- **[MVP-FIX] SWAP**: **swap_disabled**. Возвращаем только если после плейтеста станет очевидно, что без него хуже.
- **[MVP-FIX] Wrong item на check‑out**: клиент **выталкивает предмет на пол**, предмет получает **обычный урон от падения**, клиент теряет **patience** (величина зависит от типа клиента; чисел пока нет).
- **[MVP-FIX] Patience=0**: блокирует **только свой слот**; клиента можно **дообслужить** (софтлока нет).
- **[MVP-FIX] Anchor_ticket переназначение**: **только на стойке (Service Desk)** и **только платно временем**.
- **[MVP-FIX] Иконка хрупкости**: если вводим — это **значок “рюмка/fragile”** как на коробках (без текста).
- **[OPEN-PLAYTEST] “Выгнать за штраф”**: рассматриваем как альтернативу “вечному” клиенту с 0 patience — **нужен плейтест** (детали ниже).

---

## 1) Коротко о проекте

**Ядро/жанр:** визуальный менеджмент + пространственный пазл + умеренный стресс.  
**Тон:** уютный хаос / комедия ошибок / Papers, Please‑like **по вайбу** (не набор обязательных механик Papers, Please).  
**MVP:** один экран, без персонажа. Единственный UX: **drag-and-drop + click/tap**. В “руке” всегда **1 предмет**.

---

## 2) MDA (зафиксировано/
канон)

### 2.1 Aesthetics (обязательные ощущения)

- **Challenge** — игрок постоянно принимает решения под давлением.
- **Discovery** — игрок “учится читать” правила по визуальным сигналам (не чтением текста).
- **Sensation** — приятная тактильность/атмосфера (держим как направление, но не KPI MVP).

**В запасе:** **Expression** (самовыражение через порядок) — важно, но не должно раздувать MVP.

### 2.2 “Я организовал” / “Я схитрил” / стресс

- **[MVP-FIX] “Я организовал”**: первично **пространственный порядок**, вторично **временной порядок**.
- **[MVP-FIX] “Я ловко схитрил”**: **риск ради выгоды**.  
  Выгода = больше денег / меньше штрафов / не уволили.
- **[MVP-FIX] Стресс:** **умеренный**; может становиться высоким, если игрок сознательно лезет в риск‑инструменты.

### 2.3 Почему “без текста”

- **[MVP-FIX]** На карточках предметов **нет текстовых правил** (чтобы игрок не “читал”, а **играл глазами**).  
- **[MVP-FIX]** HUD с числами/таймерами **можно**.
- **[MVP-FIX]** Понимание механик идёт через:
  - визуальные маркеры (глифы/иконки),
  - анимации/состояния предметов,
  - изменения качества (звёзды),
  - поведение клиентов.

---

## 3) Основные решения игрока (Dynamics)

### 3.1 Топ‑3 решения

- **кого обслужить сейчас** (при 2 слотах у стойки)
- **где хранить предмет** (чтобы не портился и быстро находился)
- **принимать ли риск** (временной/свет/соседство/перестановки)

### 3.2 Источники напряжения

- **главный:** patience/время
- **вторичный:** опасные взаимодействия предметов (свет/соседство/падения/хрупкость)
- **[POST-MVP-PLAN]** разные типы клиентов (порог терпения/скорость падения/реакции) — уже закладываем в конфиг.

### 3.3 “Хорошая игра мастера”

- **самое важное:** красивое восстановление после ошибок (траблшутинг)
- идеальная раскладка возможна “на момент”, но игра намеренно ломает её входящими событиями

### 3.4 Ошибки по ощущению

- **[MVP-FIX]** ошибки **ощутимы, но терпимы** → пока не накопился “снежный ком”.

---

## 4) Экран, зоны, геометрия

### 4.1 Один экран

- **Storage Hall** (верх) — хранение.
- **Service Desk** (низ) — обслуживание (2 слота клиентов) + поверхность стойки.

### 4.2 Геометрия Storage Hall (арт‑референс для MVP)

- **[MVP-FIX | art]** шкафы/хранилища: **3 столбца × 2 ряда** (может меняться как арт, но сейчас так).
- **[MVP-FIX]** **шторы** — отдельный узкий столбец слева, одним действием **открыть/закрыть**.
- **[MVP-FIX]** **лампочки** — в правом столбце, “на стыках рядов”, каждая относится к своему ряду.

> Примечание: геометрия — **арт‑референс**, но она влияет на читаемость света/тени, поэтому в MVP фиксируем текущий расклад как “по умолчанию”.

---

## 5) Сущности и инфомодель (минимально)

### 5.1 Client

- `phase`: `checkin` или `checkout`
- `patience_max`, `patience_current`
- `patience_decay_rate` (скорость)
- `tip_pool` (потенциальные чаевые)
- `temper`: параметры реакций (например, штраф по patience за wrong-item)
- связи:
  - `client_id`
  - `ticket_id` (после check-in)
  - `bundle_items[]` (список вещей клиента, которые нужно вернуть)

### 5.2 Ticket / Glyph

- Ticket несёт **глиф/иконку** (руна/символ/цвет сейчас, потом руны и т.п.)
- Глиф показывается:
  - **на ticket**
  - **на клиенте** (на возврате — чтобы игрок понял “чей он”)
  - **на месте хранения** (крючок/полка/бирка) — как “адрес” хранения

### 5.3 Item

- `item_id`, `bundle_id`, `owner_client_id` (внутренняя проверка “строгой выдачи”)
- `category` (см. раздел контента)
- `quality_stars` (целое; **[OPEN]** допустимы полу‑шаги, если удобно)
- `fragile` (да/нет; позже — числовая хрупкость)
- статусы/эффекты:
  - `zombie_source_level` / `zombie_exposure_stage`
  - `vampire_light_exposure_stage`
  - `ghost` (требует свет для взаимодействия, см. ниже)

### 5.4 Storage Spot

- **крючки** (обычно 1 предмет; в будущем возможно SWAP)
- **полки** (вместимость/псевдофизика размещения; предмет может **не поместиться** и упасть)
- **[OPEN]** `anchor_ticket` как отдельная бирка/якорь (см. ниже)

---

## 6) Core loop: двухфазный клиент (check‑in → check‑out)

### 6.1 `items_per_client`

- **[MVP-FIX]** `items_per_client` задаётся **конфигом клиента**.
- **Сейчас в реализации:** **1**.
- **[POST-MVP-PLAN]** дальше будет >1 и начнёт рулиться адаптацией сложности.

### 6.2 Check‑in (сдача)

**Сцена:**
1) Клиент приходит к стойке (слот check‑in) и **вываливает вещи кучей на поверхность** стойки.  
   Даже если предмет один — он “на поверхность”, а не “в ячейку”.

2) Игрок переносит вещь(и) в Storage Hall.

3) Игрок кладёт **ticket** на стойку.

4) **[MVP-FIX] Клиент забирает ticket сразу**, как только видит его на стойке — **даже если его вещи ещё лежат на стойке**.

**Зачем так:** игрок сам создаёт себе будущий хаос (реиграбельность через собственные управленческие решения).

### 6.3 Check‑out (выдача)

1) Клиент приходит с ticket (показывает глиф на себе/номерке).

2) Игрок выкладывает клиенту его вещи.

3) **[MVP-FIX]** Каждый раз, когда на стойку выкладывается **правильная** вещь клиента — клиент **забирает её сразу**.

4) Клиент уходит, когда получил **все** вещи своего `bundle_items[]`.

---

## 7) Service Desk: поверхность, слоты, операции

### 7.1 Два слота клиентов

- **[MVP-FIX]** `service_slots_default = 2`.
- Слоты независимы по patience.
- **[MVP-FIX]** `patience=0` блокирует **только** свой слот.

### 7.2 Surface‑стойка (Papers, Please‑like)

- **[MVP-FIX]** стойка — **поверхность**, на которой предметы могут **лежать кучей и смешиваться**.
- **[MVP-FIX]** если игрок не убрал вещи первого клиента, а пришёл второй — **вещи физически смешиваются** на поверхности.  
  Разбор этого хаоса — **часть геймплея**.

**[OPEN-PLAYTEST]** Деталь реализации поверхности:
- A) простая 2D‑плоскость без физики столкновений (предметы могут пересекаться визуально)  
- B) лёгкая “фейковая физика”/стэкинг (для читаемости куч)

Для MVP допускается A, если читаемость нормальная.

### 7.3 Операции размещения

**Базовые операции:**
- Везде: **PICK / PUT**.
- **SWAP:** сейчас **выключен** (`swap_disabled`).  
  **[POST-PLAYTEST]** вернём только если станет очевидно, что без SWAP хуже.

**Про “уронил как наказание”:**
- Предмет “не остаётся в руке просто так” — если игрок отпускает в невалидной ситуации, **это приводит к падению**, но:
  - UI обязан ясно показать, что сейчас предмет **над крючком** или **над полкой**,
  - иначе плейтестер скажет “баг”.

---

## 8) Drag-and-drop UX (без текста)

### 8.1 Chameleon preview

- **[MVP-FIX]** предмет “в руке” по умолчанию крупный.
- При наведении на Storage Hall **сжимается до дропа**, чтобы не перекрывать цель.
- При наведении на Service Desk — снова крупный.
- **[OPEN-PLAYTEST]** полировка поведения на полках (сейчас ощущается хуже).

### 8.2 Подсветка и валидность

- **[MVP-FIX]** при наведении показываем:
  - подсветку цели / снап‑позу,
  - “можно/нельзя” через визуал (цвет/форма/контур), без текста.

### 8.3 Невалидный drop → падение

- **[MVP-FIX]** Невалидный drop даёт reject‑фидбек (VFX/звук) и приводит к **падению на пол**.
- **[MVP-FIX]** Важно: предмет **не исчезает** и не “телепортится” — это ключ к ощущению честности.

**[OPEN]** Падение с поверхности может ли “сбить” другие предметы?  
Для MVP: **нет цепных реакций** (иначе слишком много неожиданных фейлов). Можно вернуться после плейтеста.

---

## 9) Patience и “анти‑игнор”

### 9.1 Как убывает patience

- **[MVP-FIX]** у каждого клиента patience убывает **со временем**.
- **[MVP-FIX]** убывание идёт **пока клиент в слоте у стойки**.
- **[OPEN-PLAYTEST]** позже: убывание в очереди (другая скорость) — требуется плейтест.

### 9.2 Что происходит при `patience = 0` (точно)

**Check-in:**
- Если клиент **не дождался обслуживания** и его вещи **не были забраны со стола** → он **уходит**, страйк засчитывается.

- Если хотя бы **1 вещь была забрана со стола** → клиент считается “пошёл в таверну” **в любом случае**, просто уже с `patience=0`.

**Check-out:**
- **[MVP-FIX]** клиент с `patience=0` **остаётся и блокирует только свой слот**, пока не получит все вещи.
- **[MVP-FIX]** софтлока нет: клиента **можно дообслужить**, он уйдёт после `checkout_done`.

**Strikes:**
- **[MVP-FIX]** страйк добавляется только на событии перехода `patience: >0 → 0`.
- Если клиент пришёл во 2-й фазе уже с 0 (потому что в 1-й фазе достиг 0) — **повторно не засчитываем**.

### 9.3 “Выгнать за штраф” (альтернатива вечной блокировке)

- **[OPEN-PLAYTEST]** Рассматриваем опцию: игрок может **насильно выгнать** клиента с `patience=0` ценой большого штрафа.
  Возможные цены (выбрать 1–2 для теста):
  - A) заплатить большой **денежный штраф** в конце смены,
  - B) получить **дополнительный strike**,
  - C) очень большой **time-cost** (каналинг у стойки).
- Цель: проверить, не станет ли “вечная блокировка” слишком токсичной, и не превратится ли “выгнать” в удобную кнопку Undo.

---

## 10) Wrong item на check‑out

- **[MVP-FIX]** если игрок кладёт клиенту **чужую** вещь:
  - клиент **выталкивает предмет на пол**,
  - предмет получает **обычный урон от падения** (качество может снизиться),
  - клиент теряет **patience** (величина зависит от типа клиента; чисел нет).
- **[MVP-FIX]** если игрок кладёт **правильную** вещь — клиент забирает сразу.
- **[MVP-FIX]** если положил **не всё** — клиент ждёт дальше.

---

## 11) Качество (звёзды), падения, хрупкость

### 11.1 Звёзды качества

- **[MVP-FIX]** качество падает от:
  - падений на пол,
  - порчи (Zombie),
  - воздействия света (Vampire),
  - [POST-MVP-PLAN] других эффектов.

- Потерянные звёзды **в рамках смены не восстанавливаются**.

### 11.2 Падения

- **[MVP-FIX]** падение — единое правило урона (“упало” = “могло пострадать”).
- **[OPEN-PLAYTEST]** формула урона динамическая:
  - чем ниже качество предмета, тем **меньше** он страдает от падений (“хлам не жалко”),
  - исключение: **хрупкие** предметы (см. ниже).

### 11.3 Хрупкость

- **[MVP-FIX]** “хрупкость” как характеристика **войдёт в MVP**, но может быть реализована позже по итерациям.
- **[MVP-FIX]** коммуникация без текста:
  - **иконка “рюмка/fragile”** на карточке/над предметом.
- **[POST-MVP-PLAN]** хрупкость может зависеть от:
  - высоты падения,
  - вероятности разбиться,
  - качества предмета.

---

## 12) Порча: Zombie / Vampire

### 12.1 Общий принцип (важно для читаемости)

- **[MVP-FIX]** порча снижает качество (звёзды).
- **[MVP-FIX]** прогресс‑бары — **временный интерфейс** на ранней стадии; дальше заменяются анимациями порчи.
- **[MVP-FIX]** “прогресс накопления стадии” может сбрасываться, но уже потерянные звёзды **не вернуть**.

### 12.2 Zombie (соседство)

- **[MVP-FIX]** Zombie‑предмет портит другие предметы **в радиусе со временем**.
- **[MVP-FIX]** пока предмет **в руке**, порча **не распространяется** (рука = безопасная зона).  
  **[OPEN]** можно оставить VFX‑след/запах для атмосферы.
- **[MVP-FIX] стадийность:** влияние копится до порога → снимается часть качества → начинается новая стадия накопления.

**Сброс:**  
- **[MVP-FIX]** если убрать источник, **сбрасывается только накопление текущей стадии**, но потерянные звёзды не восстанавливаются.

**[POST-MVP-PLAN]** вторичные источники: испорченные предметы могут сами начинать портить других (рост радиуса/уровня) — вводить осторожно.

### 12.3 Vampire (свет)

- **[MVP-FIX]** Vampire‑предмет портится, если находится **в освещённой зоне**.
- Порча так же стадийная: копится → снижает качество → новая стадия.

---

## 13) Свет: источники и зоны (MVP)

### 13.1 Источники света

- **Шторы**: состояние `open/closed`.
- **Лампочки**: включение поштучно (по рядам правого столбца).

### 13.2 Зоны света (как считать “в свету”)

- **[MVP-FIX]** логика единая: источник света — сущность с зоной покрытия.
  - Шторы освещают большую зону.
  - Лампочка — локальную зону ряда.

- **[MVP-FIX]** шторы (открыто) освещают **левый + центральный столбец** Storage Hall.
- **[MVP-FIX]** лампочки освещают **соответствующий ряд правого столбца**.

- **[OPEN-PLAYTEST]** уточнение для центрального столбца (для более интересной комбинаторики):
  - вариант: шторы освещают **левую половину** центрального столбца,
  - лампы освещают **правую половину** центрального столбца (помесячно/порядово).
  Это нужно плейтестить: выигрываем ли мы “игровое чтение” или только усложняем.

### 13.3 Правило “предмет в свету?”

- **[MVP-FIX]** берём правило **по pivot/центру предмета**: если pivot в зоне света → предмет считается в свету.  
  **[OPEN-PLAYTEST]** подтвердить плейтестом.

### 13.4 Коммуникация света

- **[MVP-FIX]** никаких скрытых индикаторов “свет/тьма” текстом.
- Свет должен быть **очевиден визуально**: открыли шторы → зона заливается светом.

---

## 14) Ghost (MVP)

- **[MVP-FIX]** Ghost‑предметы есть в MVP.
- **[MVP-FIX | старт плейтеста]** режим C: **в темноте предмет блеклый и его нельзя перемещать**.
- **[OPEN-PLAYTEST]** иконка “замок” на самом предмете — можно попробовать, но сделать так, чтобы её можно было легко отключить.

**Геймплейная цель Ghost:**  
- заставить игрока **управлять светом как ресурсом доступа** (не только как источник порчи Vampire),
- добавить “планирование хранения”: где держать ghost‑вещи, чтобы не блокировать себе действия.

---

## 15) Anchor_ticket (якорный номерок)

### 15.1 Что это

- **[OPEN]** Anchor_ticket — способ привязать “адрес хранения” к вещам/группе вещей (например, бирка на зону или на предмет).

### 15.2 Переназначение

- **[MVP-FIX]** переназначение доступно **только на Service Desk**.
- **[MVP-FIX]** операция **платная временем** (каналинг/тайм‑кост).
- **[POST-MVP-PLAN]** возможен инструмент (например, “отвёртка”), чтобы удобно снимать/вешать anchor.

**[OPEN-PLAYTEST]** лимиты (сколько раз за смену, длительность) — тюним плейтестом.

---

## 16) Смена: win/lose и цели

### 16.1 Win-condition

- **[MVP-FIX]** смена заканчивается, когда выполнены оба порога:
  - `checkin_done >= N_checkin`
  - `checkout_done >= N_checkout`
- **[MVP-FIX]** `N_checkin/N_checkout` — конфиг; дефолт 1-го плейтеста: **6/4**.

### 16.2 Бардак на стойке/полу

- **[MVP-FIX]** смена завершается по счётчикам **даже если** на стойке/полу остались предметы/номерки.
- Бардак влияет на экономику/штрафы (когда они будут), но не блокирует финал смены.

### 16.3 Lose-condition (увольнение)

- **[MVP-FIX]** проигрыш/увольнение наступает при достижении **`strikes >= 3`**.

---

## 17) Очередь и микс check‑in / check‑out

### 17.1 Два пула

- `pool_checkin`: новые сдающие.
- `pool_checkout`: возвраты уже обслуженных (каждый `checkin_done` добавляет “возвратный токен”).

### 17.2 Без таймера возврата

- **[MVP-FIX]** мы **не вводим фиксированную задержку в секундах**.
- Каждый раз, когда освобождается слот, спавнер выбирает, из какого пула дать следующего клиента.

### 17.3 Правило микса (MVP‑версия)

- Считаем:
  - `need_in = N_checkin - checkin_done`
  - `need_out = N_checkout - checkout_done`
  - `outstanding = checkin_done - checkout_done`

Ограничения:
- если `need_in == 0` → только checkout
- если `need_out == 0` → только checkin
- если `outstanding == 0` → только checkin

**[MVP-FIX]** В остальном выбор идёт по “приоритету”, который отражает “динамику прибытия гостей”:
- ранняя смена тяготеет к check‑in,
- по мере накопления `outstanding` и продвижения смены — растёт приоритет check‑out.

**[OPEN-PLAYTEST]** точная формула скоринга/рандома — плейтестом.

---

## 18) Экономика (направление, без чисел)

### 18.1 Чаевые

- **[MVP-FIX]** у клиента есть `tip_pool`.
- Чаевые зависят от:
  - сколько patience потерял,
  - насколько пострадало качество вещей.

### 18.2 Штрафы

- **[MVP-FIX]** штрафы — деньги, списываемые в конце смены (пока).
- **[POST-MVP-PLAN]** позже возможны геймплейные штрафы (меняют правила), но только если игрок понимает причину.

---

## 19) Контент MVP (категории предметов)

- верхняя одежда (пальто/плащ/куртка/саван)
- головные уборы (шляпа/капюшон)
- обувь (ботинки)
- аксессуары (кольцо/амулет)
- контейнеры (коробочка/сумка/сундук)
- оружие (кинжал/посох)
- алхимия (склянка)
- **[POST-MVP-PLAN]** магические артефакты (уникальные правила хранения)

---

## 20) Самые критичные белые пятна (после v0.6)

1) **Экономика числами**: формулы чаевых/штрафов и их читаемость.  
2) **Формула микса очереди** (скоринг/рандом, чтобы ритм был “почти успеваю”).  
3) **Anchor_ticket лимиты** (иначе станет Undo).  
4) **Ghost режим**: подтвердить, что “блеклый+нельзя двигать” реально читается и не бесит.  
5) **Падения/урон**: подобрать ощущение “ошибки терпимы, пока нет снежного кома”.

---

## 21) Мини‑чеклист плейтеста (короткий)

- Понимают ли игроки, **почему** предмет упал (без текста)?
- Отличают ли за 1–2 секунды “я над крючком” vs “я над полкой”?
- Понимают ли без объяснений **глиф клиента на возврате**?
- Работает ли “хаос на стойке” как удовольствие, а не как раздражение?
- Не появляется ли стратегия “выгодно держать нулевого у стойки”?
- Ghost: “блеклый+нельзя двигать” читается как механика, а не баг?

