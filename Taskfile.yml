version: "3"

tasks:
  _require_godot_bin:
    internal: true
    preconditions:
      - sh: test -n "{{.GODOT_BIN}}"
        msg: "GODOT_BIN is required (export GODOT_BIN=/path/to/Godot)"

  web:
    deps: [_require_godot_bin]
    cmds:
      - rm -rf builds/current/web_itch
      - mkdir -p builds/current/web_itch
      - '"{{.GODOT_BIN}}" --headless --export-release "Web" builds/current/web_itch/index.html'
      - rm -f builds/current/web_itch.zip
      - cd builds/current && zip -r "web_itch.zip" "web_itch"

  web-local:
    deps: [_require_godot_bin]
    cmds:
      - rm -rf builds/current/web_local
      - mkdir -p builds/current/web_local
      - '"{{.GODOT_BIN}}" --headless --export-debug "Web (local)" builds/current/web_local/index.html'

  mac-debug:
    deps: [_require_godot_bin]
    cmds:
      - rm -rf builds/current/macos
      - mkdir -p builds/current/macos
      - '"{{.GODOT_BIN}}" --headless --export-debug "macOS" builds/current/macos/Wardrobe.app'

  build-all:
    deps:
      - web
      - web-local
      - mac-debug

  tests:
    deps: [_require_godot_bin]
    cmds:
      - chmod +x addons/gdUnit4/runtest.sh
      - |
          mkdir -p reports
          status=0
          log_file="reports/test_run_$(date +%y%m%d_%H%M%S).log"
          GODOT_BIN="{{.GODOT_BIN}}" ./addons/gdUnit4/runtest.sh -a ./tests --verbose >"$log_file" 2>&1 || status=$?
          grep -nE "(ERROR|WARN|WARNING)|Exit code" "$log_file" || true
          exit $status

  check-only:
    deps: [_require_godot_bin]
    cmds:
      - |
          if [ -z "{{.CLI_ARGS}}" ]; then
            echo "Usage: task check-only -- res://path/to/script.gd"
            exit 1
          fi
          "{{.GODOT_BIN}}" --path . --headless --check-only --script {{.CLI_ARGS}}

  save:
    cmds:
      - mkdir -p builds/archive
      - cd builds/current && zip -r "../archive/build_$(date +%y%m%d_%H%M%S).zip" .
      - rm -rf builds/current/*
